# Firebase Realtime Database 스키마 설계

## 데이터베이스 구조

```
/clinic-waiting-system/
├── patients/
│   └── {patientId}/
│       ├── id: string                    // 환자 고유 ID
│       ├── name: string                  // 환자 이름
│       ├── birthDate?: string            // 생년월일 (선택사항)
│       ├── status: string                // 환자 상태 (WAITING, EXAMINING, EXAM_WAIT, COMPLETED 등)
│       ├── roomId: string                // 진료실 ID (ROOM_1, ROOM_2)
│       ├── registeredAt: number          // 등록 시간 (timestamp)
│       ├── order: number                 // 대기 순서 (드래그 앤 드롭 순서 관리용)
│       └── completedAt?: number          // 진료 완료 일시 (timestamp, 상태가 완료일 때 기록)
│
└── settings/
    ├── roomNames/
    │   ├── ROOM_1: string                // 1진료실 이름
    │   └── ROOM_2: string                // 2진료실 이름
    ├── doctorNames/
    │   ├── ROOM_1: string                // 1진료실 원장 이름
    │   └── ROOM_2: string                // 2진료실 원장 이름
    ├── showDoctorNames: boolean          // 원장 이름 표시 여부
    ├── showBanner: boolean               // 배너 광고 영역 표시 여부
    ├── notices/
    │   └── {index}/
    │       └── text: string              // 안내 문구
    ├── bannerImages/
    │   └── {index}/
    │       └── url: string                // 배너 이미지 URL (Firebase Storage URL 또는 base64)
    └── customStatuses/
        └── {statusId}/
            ├── id: string                // 상태 ID
            ├── label: string             // 상태 라벨
            ├── color: string             // 색상 키 (blue, green, amber 등)
            ├── bgColor: string           // Tailwind 배경색 클래스
            ├── textColor: string         // Tailwind 텍스트색 클래스
            ├── borderColor?: string      // Tailwind 테두리색 클래스 (선택사항)
            └── icon?: string             // 아이콘 이름 (선택사항)
```

## 상세 스키마 설명

### 1. Patients (환자 데이터)

**경로**: `/clinic-waiting-system/patients/{patientId}`

**데이터 구조**:

```typescript
{
  id: string;              // 고유 식별자 (예: "1704067200000" 또는 UUID)
  name: string;            // 환자 이름 (예: "김철수")
  birthDate?: string;      // 생년월일 (선택사항, 예: "1990-01-01")
  status: string;         // 상태: "WAITING" | "EXAMINING" | "EXAM_WAIT" | "COMPLETED" | 커스텀 상태 ID
  roomId: string;         // 진료실: "ROOM_1" | "ROOM_2"
  registeredAt: number;    // 등록 시간 (Unix timestamp in milliseconds)
  order: number;          // 대기 순서 (같은 roomId 내에서 정렬용)
  completedAt?: number;   // 진료 완료 일시 (Unix timestamp in milliseconds, 상태가 완료일 때 기록)
}
```

**인덱싱 전략**:

- `roomId`와 `order`를 조합하여 진료실별 대기 순서 관리
- `status`로 필터링하여 상태별 환자 조회 가능
- `registeredAt`으로 시간순 정렬 가능

**보안 규칙 예시**:

```json
{
  "patients": {
    "$patientId": {
      ".read": true, // 모든 사용자 읽기 가능
      ".write": true // 인증된 사용자만 쓰기 가능 (필요시 수정)
    }
  }
}
```

### 2. Settings (설정 데이터)

**경로**: `/clinic-waiting-system/settings`

#### 2.1 Room Names (진료실 이름)

**경로**: `/clinic-waiting-system/settings/roomNames/{roomId}`

```typescript
{
  ROOM_1: string; // 예: "1진료실"
  ROOM_2: string; // 예: "2진료실"
}
```

#### 2.2 Doctor Names (원장 이름)

**경로**: `/clinic-waiting-system/settings/doctorNames/{roomId}`

```typescript
{
  ROOM_1: string; // 예: "김원장"
  ROOM_2: string; // 예: "이원장"
}
```

#### 2.3 Show Doctor Names (원장 이름 표시 여부)

**경로**: `/clinic-waiting-system/settings/showDoctorNames`

```typescript
boolean; // true | false
```

#### 2.4 Show Banner (배너 광고 영역 표시 여부)

**경로**: `/clinic-waiting-system/settings/showBanner`

```typescript
boolean; // true | false
```

배너 광고 영역을 관리자 화면과 대기 화면에 표시할지 여부를 제어합니다.

#### 2.5 Notices (안내 문구)

**경로**: `/clinic-waiting-system/settings/notices/{index}`

Firebase Realtime Database는 배열을 객체로 저장하므로, 안내 문구는 객체 형태로 저장됩니다:

```typescript
{
  "0": string;  // 예: "진료 순서가 되시면 성함을 확인하시고 진료실 앞에서 대기해주세요."
  "1": string;  // 예: "점심시간은 오후 1시부터 2시까지입니다."
  "2": string;  // 예: "주차권이 필요하신 분은 수납 시 말씀해주세요."
}
```

애플리케이션에서는 배열로 변환하여 사용하며, 저장 시 다시 객체 형태로 변환합니다.

#### 2.6 Banner Images (배너 이미지)

**경로**: `/clinic-waiting-system/settings/bannerImages/{index}`

**참고**: 현재 구현에서는 배너 이미지가 Firebase Realtime Database에 저장되지 않습니다. 로컬스토리지에만 저장됩니다.

**저장 방식**:

- Base64 Data URL: 로컬스토리지에 저장 (크기 제한: 5MB)
- Firebase Realtime Database에는 저장되지 않음 (base64 데이터가 크기 때문에)

**참고**: 코드에서는 Firebase Storage URL도 지원하도록 구현되어 있지만, 현재 `uploadBannerImage` 함수는 base64만 생성하여 로컬스토리지에 저장합니다. 따라서 실제로는 로컬스토리지에만 저장됩니다.

#### 2.7 Custom Statuses (커스텀 상태)

**경로**: `/clinic-waiting-system/settings/customStatuses/{statusId}`

```typescript
{
  "WAITING": {
    id: "WAITING",
    label: "대기",
    color: "gray",
    bgColor: "bg-gray-100",
    textColor: "text-slate-500"
  },
  "EXAMINING": {
    id: "EXAMINING",
    label: "진료 중",
    color: "blue",
    bgColor: "bg-blue-50",
    textColor: "text-[#3182F6]",
    borderColor: "border-[#3182F6]",
    icon: "stethoscope"
  },
  "EXAM_WAIT": {
    id: "EXAM_WAIT",
    label: "검사 후 대기",
    color: "amber",
    bgColor: "bg-amber-100",
    textColor: "text-amber-700",
    borderColor: "border-amber-200"
  },
  "CUSTOM_1704067200000": {
    id: "CUSTOM_1704067200000",
    label: "수납 대기",
    color: "green",
    bgColor: "bg-green-50",
    textColor: "text-green-700",
    borderColor: "border-green-200"
  }
}
```

## 데이터베이스 보안 규칙 (Firebase Rules)

```json
{
  "rules": {
    "clinic-waiting-system": {
      "patients": {
        "$patientId": {
          ".read": true,
          ".write": true,
          ".validate": "newData.hasChildren(['id', 'name', 'status', 'roomId', 'registeredAt']) && newData.child('id').isString() && newData.child('name').isString() && newData.child('status').isString() && newData.child('roomId').isString() && newData.child('registeredAt').val() is number"
        }
      },
      "settings": {
        ".read": true,
        ".write": true,
        "roomNames": {
          "$roomId": {
            ".validate": "newData.isString() && newData.val().length > 0"
          }
        },
        "doctorNames": {
          "$roomId": {
            ".validate": "newData.isString()"
          }
        },
        "showDoctorNames": {
          ".validate": "newData.isBoolean()"
        },
        "showBanner": {
          ".validate": "newData.isBoolean()"
        },
        "bannerImages": {
          "$index": {
            ".validate": "newData.isString()"
          }
        },
        "notices": {
          "$index": {
            ".validate": "newData.isString()"
          }
        },
        "customStatuses": {
          "$statusId": {
            ".validate": "newData.hasChildren(['id', 'label', 'color', 'bgColor', 'textColor'])"
          }
        }
      }
    }
  }
}
```

## 데이터 저장 방식

### Firebase 설정 저장

Firebase 연결 정보는 두 가지 방법으로 저장됩니다:

1. **LocalStorage**: 관리자 화면에서 입력한 설정이 LocalStorage에 저장됨
2. **환경 변수**: Vercel 배포 시 환경 변수로 설정 가능 (환경 변수가 우선)

### 데이터 동기화

- **실시간 구독**: `subscribeToPatients`와 `subscribeToSettings`를 통해 실시간으로 데이터 변경 감지
- **자동 저장**: 환자 추가/수정/삭제 시 즉시 Firebase에 저장
- **설정 저장**: 설정 변경은 Draft 상태로 관리되며, 저장 버튼 클릭 시 Firebase에 저장

## 성능 최적화

1. **인덱싱**: `roomId`, `order`, `status` 필드에 인덱스 생성
2. **데이터 정규화**: 환자 데이터와 설정 데이터 분리
3. **실시간 리스너**: 필요한 부분만 실시간 업데이트 구독
4. **페이징**: 환자 수가 많을 경우 페이징 처리 고려

## 주의사항

1. **환자 순서 관리**: `order` 필드를 사용하여 드래그 앤 드롭 순서 유지
2. **동시성 제어**: 여러 관리자가 동시에 수정할 경우 충돌 방지 필요
3. **데이터 백업**: 정기적인 데이터 백업 권장
4. **보안**: 프로덕션 환경에서는 인증된 사용자만 쓰기 권한 부여
